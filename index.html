<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warfarin Smart Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pill-card { transition: all 0.3s ease; }
        .pill-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-slate-700">

    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
        
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-8 text-center text-white relative">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/medical-icons.png')]"></div>
            <h1 class="text-3xl font-bold relative z-10"><i class="fa-solid fa-heart-pulse text-rose-500 mr-2"></i>Warfarin Calculator</h1>
            <p class="text-slate-300 text-sm mt-1 relative z-10">คำนวณและจัดกลุ่มตารางยาอัตโนมัติ</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Total Weekly Dose (TWD)</label>
                    <div class="relative">
                        <i class="fa-solid fa-scale-balanced absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="number" id="twd" step="0.5" placeholder="mg/week" 
                            class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none transition font-bold text-lg text-slate-800">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Current INR</label>
                    <div class="relative">
                        <i class="fa-solid fa-droplet absolute left-4 top-3.5 text-rose-400"></i>
                        <input type="number" id="inr" step="0.1" placeholder="ค่า INR" 
                            class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none transition font-bold text-lg text-slate-800">
                    </div>
                </div>
            </div>

            <button onclick="calculateDose()" 
                class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-200 transition transform active:scale-95 text-lg">
                คำนวณผลลัพธ์
            </button>

            <div id="resultSection" class="hidden space-y-6 fade-in pt-4 border-t border-slate-100">
                
                <div id="statusCard" class="p-5 rounded-xl border-l-4 flex items-start gap-4 shadow-sm bg-white">
                    </div>

                <div id="adjContainer" class="hidden text-center">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-3">ปรับขนาดยาตามเปอร์เซ็นต์</p>
                    <div id="adjButtons" class="flex flex-wrap justify-center gap-3"></div>
                </div>

                <div id="newDoseDisplay" class="hidden"></div>

                <div id="regimenSection"></div>

                <button onclick="resetCalculator()" class="w-full py-3 text-slate-400 hover:text-slate-600 font-medium transition text-sm">
                    <i class="fa-solid fa-refresh mr-1"></i> ล้างข้อมูลและเริ่มใหม่
                </button>
            </div>

            <div class="bg-amber-50 text-amber-800 p-4 rounded-lg text-xs border border-amber-100 flex gap-3">
                <i class="fa-solid fa-circle-exclamation text-lg mt-0.5"></i>
                <div>
                    <strong>Clinical Note:</strong> ถ้าพบ Major bleeding with any INR ให้ Vitamin K 10 mg IV plus FFP และ Repeat Vitamin K every 12 hours if needed.
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentTWD = 0;
        let currentINR = 0;

        // --- Core Logic ---

        function calculateDose() {
            const twdInput = document.getElementById('twd').value;
            const inrInput = document.getElementById('inr').value;

            if (!twdInput || !inrInput) return alert('กรุณากรอกข้อมูลให้ครบถ้วน');

            currentTWD = parseFloat(twdInput);
            currentINR = parseFloat(inrInput);

            document.getElementById('resultSection').classList.remove('hidden');
            setTimeout(() => document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' }), 100);

            analyzeINR();
        }

        function analyzeINR() {
            const statusCard = document.getElementById('statusCard');
            const adjContainer = document.getElementById('adjContainer');
            const newDoseDisplay = document.getElementById('newDoseDisplay');
            
            // Reset
            newDoseDisplay.classList.add('hidden');
            document.getElementById('regimenSection').innerHTML = '';
            adjContainer.classList.add('hidden');

            let config = { color: '', icon: '', title: '', text: '', btns: [], type: '' };

            if (currentINR < 1.5) {
                config = { color: 'yellow', icon: 'fa-arrow-trend-down', title: 'ค่า INR ต่ำกว่าเกณฑ์มาก', text: 'ต้องเพิ่มขนาดยา', btns: [10, 15, 20], type: 'increase' };
            } else if (currentINR >= 1.5 && currentINR <= 1.9) {
                config = { color: 'yellow', icon: 'fa-arrow-trend-down', title: 'ค่า INR ค่อนข้างต่ำ', text: 'ควรปรับเพิ่มขนาดยา', btns: [5, 7.5, 10], type: 'increase' };
            } else if (currentINR >= 2.0 && currentINR <= 3.0) {
                config = { color: 'green', icon: 'fa-check-circle', title: 'Excellent! INR ตามเป้าหมาย', text: 'ให้คงขนาดยาเดิมต่อไป', btns: [], type: 'keep' };
                // Auto calculate
                calculateRegimen(currentTWD);
                renderNewTWD(currentTWD);
            } else if (currentINR >= 3.1 && currentINR <= 3.9) {
                config = { color: 'orange', icon: 'fa-arrow-trend-up', title: 'ค่า INR สูงกว่าเกณฑ์', text: 'ต้องลดขนาดยา', btns: [5, 7.5, 10], type: 'decrease' };
            } else if (currentINR >= 4.0 && currentINR <= 4.9) {
                config = { color: 'red', icon: 'fa-hand-paper', title: 'ค่า INR สูงผิดปกติ', text: 'Hold ยาก่อน และลดขนาดยา', btns: [7.5, 10, 15], type: 'decrease' };
            } else if (currentINR >= 5.0 && currentINR <= 8.9) {
                config = { color: 'red', icon: 'fa-ban', title: 'อันตราย: INR สูงมาก', text: 'Hold ยาก่อน 1-2 dose, ลดยา, พิจารณา Vit K', btns: [10, 15, 20], type: 'decrease' };
            } else {
                config = { color: 'red', icon: 'fa-skull-crossbones', title: 'CRITICAL', text: 'Hold ยา + พิจารณา Vitamin K ทันที', btns: [], type: 'critical' };
            }

            renderStatus(config);
            if (config.btns.length > 0) renderButtons(config.btns, config.type);
        }

        function renderStatus({ color, icon, title, text }) {
            const colors = {
                yellow: 'bg-yellow-50 border-yellow-400 text-yellow-800',
                green: 'bg-green-50 border-green-500 text-green-800',
                orange: 'bg-orange-50 border-orange-500 text-orange-800',
                red: 'bg-red-50 border-red-600 text-red-800'
            };
            const theme = colors[color] || colors.red;
            
            document.getElementById('statusCard').className = `p-5 rounded-xl border-l-4 flex items-start gap-4 shadow-sm ${theme}`;
            document.getElementById('statusCard').innerHTML = `
                <div class="mt-1 text-2xl"><i class="fa-solid ${icon}"></i></div>
                <div>
                    <h3 class="font-bold text-lg">${title}</h3>
                    <p class="opacity-90 text-sm">${text}</p>
                </div>
            `;
        }

        function renderButtons(pcts, type) {
            const container = document.getElementById('adjButtons');
            document.getElementById('adjContainer').classList.remove('hidden');
            
            const isInc = type === 'increase';
            const colorClass = isInc 
                ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-500 hover:text-white' 
                : 'bg-rose-50 text-rose-700 border-rose-200 hover:bg-rose-500 hover:text-white';
            const icon = isInc ? '+' : '-';

            container.innerHTML = pcts.map(p => `
                <button onclick="applyAdjustment(${p}, '${type}')" 
                    class="flex-1 min-w-[80px] py-3 px-4 rounded-xl border font-bold text-lg transition ${colorClass}">
                    ${icon}${p}%
                </button>
            `).join('');
        }

        function applyAdjustment(pct, type) {
            let val = type === 'increase' 
                ? currentTWD * (1 + pct/100) 
                : currentTWD * (1 - pct/100);
            
            // Round logic: Nearest 0.5
            val = Math.round(val * 2) / 2;
            
            renderNewTWD(val);
            calculateRegimen(val);
        }

        function renderNewTWD(val) {
            const el = document.getElementById('newDoseDisplay');
            el.classList.remove('hidden');
            el.innerHTML = `
                <div class="bg-slate-800 text-white p-6 rounded-2xl text-center shadow-lg mb-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Target Total Weekly Dose</p>
                        <h2 class="text-4xl font-bold text-brand-400">${val.toFixed(1)} <span class="text-xl text-white">mg/week</span></h2>
                    </div>
                    <i class="fa-solid fa-pills absolute -right-6 -bottom-6 text-8xl text-white opacity-5"></i>
                </div>
            `;
        }

        // --- Regimen Algorithm ---

        function calculateRegimen(targetTWD) {
            const available = [
                { strength: 5, label: '5 mg' },
                { strength: 3, label: '3 mg' },
                { strength: 2, label: '2 mg' }
            ];

            // 1. Find best math combination
            let bestSolution = null;
            let bestSD = Infinity;

            for (let s1 of available) {
                for (let t1 of [0, 0.5, 1, 1.5, 2]) { // Tabs 1
                    for (let s2 of available) {
                        for (let t2 of [0, 0.5, 1, 1.5, 2]) { // Tabs 2
                            
                            const dose1 = s1.strength * t1;
                            const dose2 = s2.strength * t2;

                            // Loop Days Split (0-7)
                            for (let d1 = 0; d1 <= 7; d1++) {
                                const d2 = 7 - d1;
                                const total = (dose1 * d1) + (dose2 * d2);

                                // Check TWD match
                                if (Math.abs(total - targetTWD) < 0.01) {
                                    
                                    let patterns = [];
                                    if (d1 > 0) patterns.push({ dose: dose1, days: d1, strength: s1, tabs: t1 });
                                    if (d2 > 0) patterns.push({ dose: dose2, days: d2, strength: s2, tabs: t2 });

                                    // Merge if dose is same
                                    if (patterns.length === 2 && patterns[0].dose === patterns[1].dose) {
                                        patterns = [{ ...patterns[0], days: 7 }];
                                    }

                                    if (patterns.length > 2) continue;

                                    // Calc SD
                                    let daily = [];
                                    patterns.forEach(p => { for(let k=0; k<p.days; k++) daily.push(p.dose); });
                                    
                                    const mean = daily.reduce((a,b)=>a+b,0)/7;
                                    const variance = daily.reduce((a,b)=>a+Math.pow(b-mean,2),0)/7;
                                    const sd = Math.sqrt(variance);

                                    if (sd < 3 && sd < bestSD) {
                                        bestSD = sd;
                                        bestSolution = { patterns, sd };
                                    }
                                }
                            }
                        }
                    }
                }
            }

            renderRegimenCards(bestSolution, targetTWD);
        }

        // --- Render UI (The "Grouped" Display) ---

        function renderRegimenCards(solution, targetTWD) {
            const container = document.getElementById('regimenSection');
            
            if (!solution) {
                container.innerHTML = `
                    <div class="text-center p-8 bg-slate-50 rounded-xl text-slate-500">
                        <i class="fa-solid fa-file-circle-xmark text-4xl mb-2 text-slate-300"></i>
                        <p>ไม่สามารถคำนวณสูตรยาที่ลงตัวได้ (SD < 3)</p>
                        <p class="text-sm">กรุณาปรึกษาแพทย์เพื่อปรับ TWD</p>
                    </div>`;
                return;
            }

            const dayNames = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์', 'อาทิตย์'];
            let html = `<div class="space-y-3">`;
            let currentDayIndex = 0;

            solution.patterns.forEach((p, index) => {
                // Calculate Day Range String
                const startDay = dayNames[currentDayIndex];
                const endDay = dayNames[currentDayIndex + p.days - 1];
                let dayLabel = (p.days === 1) ? startDay : `${startDay} - ${endDay}`;
                
                // Special case for 7 days
                if (p.days === 7) dayLabel = "กินทุกวัน (จันทร์ - อาทิตย์)";
                
                // Calculate Total for this row (Calculation method)
                const rowTotal = p.dose * p.days;

                // Generate Pill Text
                let pillText = "";
                let subText = "";
                
                if (p.dose === 0) {
                    pillText = `<span class="text-slate-400">หยุดยา</span>`;
                    subText = `
                        <div class="font-bold text-slate-400 text-lg">0 mg/วัน</div>
                        <div class="text-xs text-slate-300 mt-1">0 mg × ${p.days} วัน = 0 mg</div>
                    `;
                } else {
                    const tabStr = p.tabs === 0.5 ? 'ครึ่งเม็ด' : p.tabs === 1.5 ? '1 เม็ดครึ่ง' : p.tabs + ' เม็ด';
                    
                    // Design: Main Pill Text
                    pillText = `
                        <span class="font-bold text-slate-700 text-lg">
                            ${p.strength.label} <span class="text-brand-600">(${tabStr})</span>
                        </span>`;
                        
                    // Design: Dose sum & Calc (NEW: Added small calculation text)
                    subText = `
                        <div class="font-bold text-slate-500 text-lg">(${p.dose} mg/วัน)</div>
                        <div class="text-xs text-slate-400 mt-1 font-medium bg-slate-100 inline-block px-2 py-0.5 rounded">
                            ${p.dose} mg × ${p.days} วัน = ${rowTotal} mg
                        </div>
                    `;
                }

                // Card Theme
                const cardBg = index === 0 ? 'bg-white border-brand-200 shadow-brand-100' : 'bg-slate-50 border-slate-200';
                const dayBadgeColor = index === 0 ? 'bg-brand-100 text-brand-700' : 'bg-slate-200 text-slate-600';

                html += `
                    <div class="pill-card border rounded-2xl p-4 flex justify-between items-center shadow-sm ${cardBg}">
                        <div>
                            <div class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 ${dayBadgeColor}">
                                ${dayLabel}
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-capsules text-slate-300"></i>
                                ${pillText}
                            </div>
                        </div>
                        <div class="text-right">
                            ${subText}
                        </div>
                    </div>
                `;

                currentDayIndex += p.days;
            });

            html += `</div>`;
            
            // Add SD Badge
            html += `
                <div class="text-right mt-2 flex justify-end items-center gap-2">
                     <span class="text-xs text-slate-300">Total Check: ${(Math.round(solution.patterns.reduce((a,b)=>a+(b.dose*b.days),0)*2)/2).toFixed(1)} mg</span>
                     <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">SD: ${solution.sd.toFixed(2)}</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function resetCalculator() {
            document.getElementById('twd').value = '';
            document.getElementById('inr').value = '';
            document.getElementById('resultSection').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
